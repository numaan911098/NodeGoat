name: NodeGoat Vorpal Security Analysis

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  vorpal-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # Find all JavaScript files dynamically
      - name: Find JavaScript files
        id: find-js-files
        run: |
          # Find all .js files, exclude node_modules, format as comma-separated
          JS_FILES=$(find . -name "*.js" -not -path "./node_modules/*" -not -path "./coverage/*" -not -path "./logs/*" | tr '\n' ',' | sed 's/,$//')
          echo "js_files=$JS_FILES" >> $GITHUB_OUTPUT
          echo "Found files: $JS_FILES"
        
      # Run Vorpal on discovered files
      - name: Vorpal Security Scan
        if: steps.find-js-files.outputs.js_files != ''
        uses: checkmarx/vorpal-reviewdog-github-action@v1.2.0
        with:
          source_path: "${{ steps.find-js-files.outputs.js_files }}"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          level: warning
          fail_on_error: false
          filter_mode: file
